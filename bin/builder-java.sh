#!/bin/bash

if [ ! -f $HOME/dev-tools/bin/commons.source ]; then
    echo "Error: where is your $HOME/dev-tools/bin directory. Can't find commons.source."
    echo "Set it up first: svn co https://izuma.repositoryhosting.com/svn/izuma_frzsoftware/dev-tools from your home dir"
    exit -1
fi

source $HOME/dev-tools/bin/commons.source
source $HOME/dev-tools/bin/html-logger.sh

# workspace dir
WSPACE_DIR="$HOME/workspace"
BLD_CFG="builder.cfg"

# out main output file
ANT_OUTFILE="builder.xml"

ANT_AUX_LIBS="$HOME/dev-tools/lib"

THIS_OUTPUT_DIRS=""


THIS_DIR=""

function print_usage () {
	echo "$0 [Options] project-name target:{compile|clean|rebuild}"
	echo "   -w [dir]    Set workspace directory to [dir] (Default: $WSPACE_DIR)"
	echo "   -H [file]   Log all output to [file] - as HTML output"
	echo "   defaut: no target = compile"
}


function fail_politely () {
    eval $COLOR_RED
    echo "Failure: $1"
    eval $COLOR_NORMAL
    exit 255
}



function make_outfile () {
    if [ -f $ANT_OUTFILE ]; then
	eval $COLOR_YELLOW
	echo "Overwriting old $THIS_DIR/$ANT_OUTFILE"
	eval $COLOR_NORMAL
    fi
# <!-- this file auto generated by $0. Don't edit manually. -->
    cat > $THIS_DIR/$ANT_OUTFILE <<EOF
<?xml version="1.0" encoding="UTF-8"?>
<!-- this file auto generated by $0. Don't edit manually. -->
<project name="buildwebui" default="compile" basedir="."
	 xmlns:antcontrib="antlib:net.sf.antcontrib"
	 xmlns:ant4eclipse="antlib:org.ant4eclipse">

  <property name="workspace"   value="$WSPACE_DIR"/>
  <property file="frzbuild.properties"/>

  <ant4eclipse:installedJREs>
    <jre id="java-1.6.0-openjdk" location="/usr/lib/jvm/java-1.6.0-openjdk" />
  </ant4eclipse:installedJREs>


  <target name="clean">
EOF

    for D in $THIS_OUTPUT_DIR; do
    echo "    <delete dir=\"$D\"/>" >> $ANT_OUTFILE
    done
    echo "  </target>" >> $ANT_OUTFILE
    echo "<!-- references to prereqs project classpaths...-->" >> $ANT_OUTFILE
    echo "  <path id=\"framez-classpath\">" >> $ANT_OUTFILE
    for D in $OUT_BUILT_CP; do
    echo "    <pathelement path=\"$D\"/>" >> $ANT_OUTFILE
    done
    for D in $JAR_DIRS; do
    echo "    <fileset dir=\"$THIS_DIR/$D\">" >> $ANT_OUTFILE
    echo "       <include name=\"**/*.jar\"/>" >> $ANT_OUTFILE
    echo "    </fileset>" >> $ANT_OUTFILE
    done


    echo "  </path>" >> $ANT_OUTFILE
    
    
    J_SRC_DIRS=""
    for F in $SRC_DIRS; do 
	echo "Adding src dir $F"
	J_SRC_DIRS="$J_SRC_DIRS$F:"
    done
    echo "<!-- compile target -->" >> $ANT_OUTFILE
    echo "  <target name=\"compile\">" >> $ANT_OUTFILE
    for D in $OUTPUT_CLASS_DIR; do 
	echo "     <mkdir dir=\"$D\"/>" >> $ANT_OUTFILE
    done


    echo "      <javac srcdir=\"$J_SRC_DIRS\" destdir=\"$OUTPUT_CLASS_DIR\" failonerror=\"false\" includeantruntime=\"false\" bootclasspath=\"\${sun.boot.class.path}\">  " >> $ANT_OUTFILE


    echo "      <classpath>" >> $ANT_OUTFILE
    echo "        <path refid=\"framez-classpath\"/>" >> $ANT_OUTFILE
    echo "      </classpath>" >> $ANT_OUTFILE
    echo "    </javac>" >> $ANT_OUTFILE
    echo "  </target>" >> $ANT_OUTFILE
    echo "</project>" >> $ANT_OUTFILE
}

while getopts "hw:H:" opt; do
    case $opt in
#	d)  
#	    if [ "$OPTARG" = "DBUS" ]; then
#		_DBUS_LIB=$_DBUS_DEBUG_LIB
#	    else
#		eval $COLOR_RED
#		echo "Unknown DEBUG option"
#		eval $COLOR_NORMAL
#		exit 1
#	    fi
#       shift
#	    shift
#      	;;
	h)
	    print_usage
	    exit
	    ;;
#    	shift
#    	shift
	w)
	    WSPACE_DIR="$OPTARG"
	    ;;
	H) 
	    HTML_OUTFILE="$OPTARG"
	    HTML_LOGGER_FILE="$OPTARG" # for html-logger.sh module above
	    ;;
	\?) 
	    eval $COLOR_RED
	    echo "Unknown option. $OPTARG"
	    eval $COLOR_NORMAL
	    exit 1
	    ;;
	:)
	    eval $COLOR_RED
	    echo "Option -$OPTARG requires an argument"
	    eval $COLOR_NORMAL
	    exit 1
	    ;;
    esac
done

shift $(($OPTIND - 1))

if [ $# -gt 0 ]; then
    eval $COLOR_BOLD
    echo "Build package: $1"
    eval $COLOR_NORMAL
else
    print_usage
    exit 255
fi

if [ ! -d "$WSPACE_DIR" ]; then
    eval $COLOR_RED
    echo "Can't find workspace dir: $WSPACE_DIR"
    eval $COLOR_NORMAL
    exit 255
fi

if [ ! -e "$WSPACE_DIR/$1/$BLD_CFG" ]; then
    log_error "Can't find builder config file: $WSPACE_DIR/$1/$BLD_CFG"
    exit 255
fi

THIS_DIR="$WSPACE_DIR/$1"

source "$WSPACE_DIR/$1/$BLD_CFG"

echo "project needs: $NEEDS_PROJS ... Looking..."

PREREQ_PROJS="$NEEDS_PROJS"
THIS_OUTPUT_DIR="$OUTPUT_CLASS_DIR"

MISSING_LIST=""

OUT_BUILT_CP=""

#FOUND_FOLDER=""

for NEED in $PREREQ_PROJS; do 
    FOUND=
# only look in directories which have a builder.cfg file
    for FOLDER in $WSPACE_DIR/*; do
	if [ -d "$FOLDER" ]; then
	    if [ -e "$FOLDER/$BLD_CFG" ]; then
		source "$FOLDER/$BLD_CFG"
		if [ "$MY_NAME" = "$NEED" ]; then
		    log_important "Found project $NEED @ $FOLDER"
		    FOUND="$FOLDER"
		    OUTPUT_CLASS_DIR_THIS="$OUTPUT_CLASS_DIR"
		fi
	    fi
	fi
    done
    if [ -z $FOUND ]; then
	MISSING_LIST=$MISSING_LIST" "$NEED
	log_warning "Failed to find $NEED - required to build $1 project."
    else 
	if [ ! -z "$OUTPUT_CLASS_DIR_THIS" ]; then
	    for E in $OUTPUT_CLASS_DIR_THIS; do  # this is a variable defined in the builder.cfg
	    FULL_E="$FOUND/$E"
#	    if [ ! -z "$OUT_BUILT_CP" ]; then
#		OUT_BUILT_CP="$OUT_BUILT_CP"":"
#	    fi
	    OUT_BUILT_CP="$OUT_BUILT_CP $FULL_E"
#	    echo "<pathelement path=\"$FULL_E\"/>"
	    done
	fi
    fi
    FOUND=""

done

# re-source it - b/c we need to have the variables for 'this' project
# zero out values in case they are not defined...
JAR_DIRS=""
SRC_DIRS=""
ANT_EXEC="ant"

source "$WSPACE_DIR/$1/$BLD_CFG"


if [ ! -z "$MISSING_LIST" ]; then
    fail_politely "Missing $MISSING_LIST"
fi


echo "OUT_BUILT_CP: $OUT_BUILT_CP"

CURR_DIR=`pwd`

pushd $THIS_DIR
make_outfile

log_important $ANT_EXEC -f $ANT_OUTFILE -lib $ANT_AUX_LIBS/org.ant4eclipse_2105.jar -lib $ANT_AUX_LIBS/ecj-3.7.1.jar -lib $ANT_AUX_LIBS/org.eclipse.osgi_3.6.0.v20100517.jar -lib $ANT_AUX_LIBS/ant-contrib-1.0b3.jar -Dbuild.compiler=org.eclipse.jdt.core.JDTCompilerAdapter -Dant.build.javac.target=1.6 -Dant.build.javac.source=1.6 $2

if [ -z "$HTML_OUTFILE" ]; then
    $ANT_EXEC -f $ANT_OUTFILE -lib $ANT_AUX_LIBS/org.ant4eclipse_2105.jar -lib $ANT_AUX_LIBS/ecj-3.7.1.jar -lib $ANT_AUX_LIBS/org.eclipse.osgi_3.6.0.v20100517.jar -lib $ANT_AUX_LIBS/ant-contrib-1.0b3.jar -Dbuild.compiler=org.eclipse.jdt.core.JDTCompilerAdapter -Dant.build.javac.target=1.6 -Dant.build.javac.source=1.6 $2
else
    WHEREIS=`readlink -f $HTML_OUTFILE`
    echo "Output to $WHEREIS"
    touch "$WHEREIS"  # just make sure its there...
    
    $ANT_EXEC -f $ANT_OUTFILE -lib $ANT_AUX_LIBS/org.ant4eclipse_2105.jar -lib $ANT_AUX_LIBS/ecj-3.7.1.jar -lib $ANT_AUX_LIBS/org.eclipse.osgi_3.6.0.v20100517.jar -lib $ANT_AUX_LIBS/ant-contrib-1.0b3.jar -Dbuild.compiler=org.eclipse.jdt.core.JDTCompilerAdapter -Dant.build.javac.target=1.6 -Dant.build.javac.source=1.6 $2 2>&1 | html-javac.pl >> "$HTML_OUTFILE"
fi
popd
#if [ ! -z "$HTML_OUTFILE" ]; then
#    mv $THIS_DIR/"$HTML_OUTFILE" .
#fi
